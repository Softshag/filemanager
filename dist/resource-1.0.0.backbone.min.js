!function(t,e){"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):t.Resource=e(t._,t.Backbone)}(this,function(_,Backbone){var Resource={};Resource.$=Backbone.$,Resource.Events=Backbone.Events;var BaseView=Backbone.View,Collection=Backbone.Collection,Model=Backbone.Model,Utils=_,Inherits=function(t,e){function n(){this.constructor=t}for(var i in e)Utils.has(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},Ajax=function(){var t;if(null!=window.XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("msxml2.xmlhttp.6.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp.3.0")}catch(e){t=e}try{return new ActiveXObject("msxml2.xmlhttp")}catch(e){t=e}},detailsTemplate=function anonymous(obj){obj||(obj={});var p=[];with(obj)p.push('<div class="fm-resource-details-container">\n  <div class="fm-resource-details-thumbnail-container">\n    <img />\n  </div>\n  <div class="fm-resource-details-info-container">\n    <h5>',path,"</h5>\n    <span><small>size:</small>",size," kb</span>\n    <span><small>type:</small>",mime,"</span>\n  </div>\n</div>\n");return p.join("")},listitemTemplate=function anonymous(obj){obj||(obj={});var p=[];with(obj)p.push('<div>\n  <div class="fm-resource-item-thumbnail">\n    <img />\n  </div>\n\n\n  <span>',path,"</span>\n</div>\n");return p.join("")},listTemplate=function anonymous(obj){obj||(obj={});var p=[];with(obj)p.push('<div class="fm-resource-list-container">\n  <div class="fm-resource-list-toolbar">\n    <button type="button" class="fm-toolbar-btn list-btn">List</button>\n    <button type="button" class="fm-toolbar-btn collection-btn">Collection</button>\n  </div>\n  <div class="fm-resource-list-container-inner">\n    <ul class="fm-resource-list">\n  </div>\n\n  </ul>\n</div>\n');return p.join("")},viewTemplate=function anonymous(obj){obj||(obj={});var p=[];with(obj)p.push('<div class="fm-container">\n  <div class="fm-container-inner">\n    <div class="fm-list-container">\n\n    </div>\n    <div class="fm-details-container">\n    </div>\n  </div>\n  <div class="fm-button-bar">\n    <button type="button" class="remove-btn">Remove</button>\n    <button type="button">Add</button>\n  </div>\n</div>\n');return p.join("")},FileUpload=function(){function t(t){this.options=t||{}}function e(t){var e=null;try{e=JSON.parse(t)}catch(n){e=t}return e}function n(t){if("function"==typeof this.options.maxSize){if(!this.options.maxSize(t))return new Error("file too big")}else if(t.size>this.options.maxSize)return new Error("File too big");var e=t.type,n=this.options.mimeType;if(n){if("function"==typeof n)return n(t);Array.isArray(n)||(n=[n]);for(var i=null,o=0;o<n.length;o++){if(mime=new RegExp(n[o].replace("*",".*")),mime.test(e))return null;i=new Error("Wrong mime type")}return i}}return Utils.extend(t.prototype,Resource.Events),t.prototype.upload=function(t,i,o){var s=this,r=new FormData,l=n.call(this,t);if(l)return void this.trigger("error",t,l);r.append(this.options.param,t),i=i||{},Object.keys(i).forEach(function(t){var e=i[t];r.append(t,e)});var a=Ajax();return a.open(this.options.method,this.options.url),a.onerror=function(){var n={code:a.status,message:e(a.responseText)};s.trigger("error",t,n)},a.onreadystatechange=function(){if(4==a.readyState){var n=e(a.responseText);200==a.status||201==a.status?(o&&o(null,n),s.trigger("complete",t,n)):(o&&o(n,null),s.trigger("error",t,n))}},a.upload.onprogress=function(e){if(e.lengthComputable){var n=e.loaded/e.total*100||0;s.trigger("progress",t,n)}},a.send(r),this},t.defaults={maxSize:1024,mimeType:null,param:"file"},t}(),UploadButton=function(){function t(t,o){this.options=o||{},this._executing=!1,this.files=[],this.el=t,this.options=o,this._upload=new FileUpload(o),this._upload.on("complete",_.bind(n,this)),this._upload.on("progress",_.bind(i,this)),this._upload.on("error",_.bind(e,this));var s=this;t.addEventListener("change",function(){s.files=[];for(var e=0;e<t.files.length;e++)s.files.push(t.files[e]);s.upload()})}function e(t,e){this.trigger("error",t,e)}function n(t,e){this.trigger("complete",t,e)}function i(t,e){this.trigger("progress",t,e)}Utils.extend(t.prototype,Resource.Events),t.prototype.upload=function(){var t=this;this._executing=!0,o(this.files,function(e,n){t._upload.upload(e,{},n)},function(){})},t.prototype.dispose=function(){this._upload.off(),this.el.removeEventListener("change"),self._upload=null};var o=function(t,e,n){if(!Array.isArray(t))throw new TypeError("each() expects array as first argument");if("function"!=typeof e)throw new TypeError("each() expects function as second argument");if("function"!=typeof n&&(n=Function.prototype),0===t.length)return n(void 0,t);var i=new Array(t.length),o=0,s=!1;t.forEach(function(r,l){e(r,function(e,r){return s?void 0:e?(s=!0,n(e)):(i[l]=r,o+=1,o===t.length?n(void 0,i):void 0)})})};return t}(),MediaCollection=function(t){function e(e){e=e||{},this.model=Model,Utils.extend(this,Utils.pick(e,["url"])),t.prototype.constructor.call(this)}return Inherits(e,t),e}(Collection),ListItemView=function(t){function e(e){this.tagName="li",t.prototype.constructor.call(this,e),this.template=listitemTemplate}return Inherits(e,t),Utils.extend(e.prototype,{events:{click:function(){this.trigger("select",this)}},render:function(){return console.log(this.model),this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),this},remove:function(){t.prototype.remove.call(this)}}),e}(BaseView),ListView=function(t){function e(n){n=n||{},t.prototype.constructor.call(this,n),this.options=Utils.extend({},n,e.defaults),this.onStyleButton=Utils.bind(this.onStyleButton,this),this.template=this.options.template||listTemplate;this._items=[],this.bindEvents()}return Inherits(e,t),e.prototype.render=function(){return this.$el.html(this.template()),this._listView=this.$(".fm-resource-list"),this.delegateEvents(),this._listView.addClass(this.options.style+"-style"),this},e.prototype.onStyleButton=function(t){var e=Resource.$(t.target);e.hasClass("collection-btn")?this._listView.removeClass("list-style").addClass("collection-style"):this._listView.removeClass("collection-style").addClass("list-style")},e.prototype.renderItems=function(){Utils.each(this._items,function(t){t.remove()}),this._items=[];var t=this,e=document.createDocumentFragment();Utils.each(this.collection.models,function(n){var i=t.renderItem(n);e.appendChild(i.render().el)}),this._listView.append(e)},e.prototype.renderItem=function(t){var e=new ListItemView({model:t,className:"fm-resource-item id-"+t.id}),n=this;return e.on("select",function(t){Utils.each(n._items,function(t){t.$el.removeClass("selected")}),t.$el.addClass("selected"),n.trigger("select",t.model),n.selected=t}),n._items.push(e),e},e.prototype.events={"click .collection-btn":"onStyleButton","click .list-btn":"onStyleButton"},e.prototype.bindEvents=function(){this.collection.off();var t=this;this.collection.on("change",function(){t.renderItems.call(t)}),this.collection.on("add",function(e){var n=t.renderItem(e);t._listView.append(n.render().el)}),this.collection.on("remove",function(e){for(var n=null,i=0;i<t._items.length&&(n=t._items[i],n.model!=e);i++)n=null;n&&(Utils.addClass(n.el,"deleting"),setTimeout(function(){n.remove()},400))})},e.prototype.remove=function(){t.prototype.remove.call(this),Utils.each(this.items,function(t){t.remove()})},e.defaults={style:"list"},e}(BaseView),DetailsView=function(t){function e(e){e=e||{},t.prototype.constructor.call(this,e),this.options=e,this.template=this.options.template||detailsTemplate}return Inherits(e,t),Utils.extend(e.prototype,{render:function(){var t=this.model?this.model.toJSON():{path:null,size:null,mime:null};return console.log(t),this.$el.html(this.template(t)),this}}),e}(BaseView),ManagerView=function(t){function e(e){e=e||{},t.prototype.constructor.call(this,e),this.options=e,this.collection=new MediaCollection({url:"files"}),this.template=this.options.template||viewTemplate,this.listView=new ListView({collection:this.collection});var n=this;this.detailsView=new DetailsView({}),this.listView.on("select",function(t){n.detailsView.model=t,n.detailsView.render()})}return Inherits(e,t),Utils.extend(e.prototype,{events:{"click .remove-btn":"onItemRemove","click .add-btn":"onItemAdd"},render:function(){this.$el.html(this.template({}));var t=this.$(".fm-list-container");t.append(this.listView.render().el);var e=this.$(".fm-details-container");return e.append(this.detailsView.render().el),this.delegateEvents(),this},onItemRemove:function(){this.collection.remove(this.listView.selected.model)},onItemAdd:function(){},remove:function(){t.prototype.remove.call(this),this.listView.remove()}}),e}(BaseView);return Resource.UploadButton=UploadButton,Resource.ListView=ListView,Resource.ManagerView=ManagerView,Resource});